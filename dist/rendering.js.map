{"version":3,"sources":["../src/rendering.js"],"names":["link","scope","elem","attrs","ctrl","data","panel","find","$tooltip","$","events","on","render","legendType","setTimeout","setElementHeight","height","row","_","isString","parseInt","replace","title","offset","fullscreen","allowViewModeFilter","querybarHeight","teldFilterHeight","css","e","formatter","label","slice","fontSize","color","Math","round","percent","addPieChart","width","size","min","plotCanvas","plotCss","top","margin","position","$panelContainer","parents","backgroundColor","options","legend","show","series","pie","stroke","parseFloat","strokeWidth","toFixed","highlight","opacity","combine","threshold","grid","hoverable","clickable","pieType","innerRadius","html","plot","error","message","bind","event","pos","item","detach","body","formatted","formatValue","totalPercentage","totalpercent","tooltips","isNil","percentage","percentageLabel","totalPercentageLabel","place_tt","pageX","pageY","incrementRenderCounter","renderingCompleted"],"mappings":"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","file":"rendering.js","sourcesContent":["import _ from 'lodash';\r\nimport $ from 'jquery';\r\nimport 'jquery.flot';\r\nimport 'jquery.flot.pie';\r\n\r\nexport default function link(scope, elem, attrs, ctrl) {\r\n  var data, panel;\r\n  elem = elem.find('.piechart-panel');\r\n  var $tooltip = $('<div id=\"tooltip\">');\r\n\r\n  ctrl.events.on('render', function() {\r\n    render(false);\r\n    if(panel.legendType === 'Right side') {\r\n      setTimeout(function() { render(true); }, 50);\r\n    }\r\n  });\r\n\r\n  function setElementHeight() {\r\n    try {\r\n      var height = ctrl.height || panel.height || ctrl.row.height;\r\n      if (_.isString(height)) {\r\n        height = parseInt(height.replace('px', ''), 10);\r\n      }\r\n\r\n      height -= 5; // padding\r\n      height -= panel.title ? 24 : 9; // subtract panel title bar\r\n\r\n      var offset = 0;\r\n      if (ctrl.fullscreen && ctrl.panel.allowViewModeFilter) {\r\n        var querybarHeight = $(\".teld-querybar-panel\").height() || 0;\r\n        var teldFilterHeight = $(\"panel-plugin-teld-filter-panel .panel-container\").height() || 0;\r\n        offset = (querybarHeight + teldFilterHeight);\r\n      }\r\n      height -= offset;\r\n      elem.css('height', height + 'px');\r\n\r\n      return true;\r\n    } catch(e) { // IE throws errors sometimes\r\n      return false;\r\n    }\r\n  }\r\n\r\n  function formatter(label, slice) {\r\n    return \"<div style='font-size:\" + ctrl.panel.fontSize + \";text-align:center;padding:2px;color:\" + slice.color + \";'>\" + label + \"<br/>\" + Math.round(slice.percent) + \"%</div>\";\r\n  }\r\n\r\n  function addPieChart() {\r\n    var width = elem.width();\r\n    var height = elem.height();\r\n\r\n    var size = Math.min(width, height);\r\n\r\n    var plotCanvas = $('<div></div>');\r\n    var plotCss = {\r\n      top: '10px',\r\n      margin: 'auto',\r\n      position: 'relative',\r\n      height: (size - 20) + 'px'\r\n    };\r\n\r\n    plotCanvas.css(plotCss);\r\n\r\n    var $panelContainer = elem.parents('.panel-container');\r\n    var backgroundColor = $panelContainer.css('background-color');\r\n\r\n    var options = {\r\n      legend: {\r\n        show: false\r\n      },\r\n      series: {\r\n        pie: {\r\n          show: true,\r\n          stroke: {\r\n            color: backgroundColor,\r\n            width: parseFloat(ctrl.panel.strokeWidth).toFixed(1)\r\n          },\r\n          label: {\r\n            show: ctrl.panel.legend.show && ctrl.panel.legendType === 'On graph',\r\n            formatter: formatter\r\n          },\r\n          highlight: {\r\n            opacity: 0.0\r\n          },\r\n\t\t  combine: {\r\n\t\t    threshold: ctrl.panel.combine.threshold,\r\n\t\t\tlabel: ctrl.panel.combine.label\r\n\t\t  }\r\n        }\r\n      },\r\n      grid: {\r\n        hoverable: true,\r\n        clickable: false\r\n      }\r\n    };\r\n\r\n    if (panel.pieType === 'donut') {\r\n      options.series.pie.innerRadius = 0.5;\r\n    }\r\n\r\n    elem.html(plotCanvas);\r\n\r\n    try {\r\n      $.plot(plotCanvas, ctrl.data, options);\r\n    } catch (error) {\r\n      if (error.message === \"Invalid dimensions for plot, width = 0, height = 0\") {\r\n        return;\r\n      }\r\n    }\r\n\r\n    plotCanvas.bind(\"plothover\", function (event, pos, item) {\r\n      if (!item) {\r\n        $tooltip.detach();\r\n        return;\r\n      }\r\n\r\n      var body;\r\n      var percent = parseFloat(item.series.percent).toFixed(2);\r\n      var formatted = ctrl.formatValue(item.series.data[0][1]);\r\n      let label = item.series.label.replace(`[:]${panel.legend.label}`, '')\r\n\r\n      body = '<div class=\"graph-tooltip-small\"><div class=\"graph-tooltip-time\">';\r\n      body += '<div class=\"graph-tooltip-value\">' + label + ': ' + formatted;\r\n      if (ctrl.panel.legend.totalPercentage) {\r\n        var totalpercent = ctrl.tooltips[label];\r\n        if (false === _.isNil(totalpercent)) {\r\n          if (ctrl.panel.legend.percentage) {\r\n            body +=`(${ctrl.panel.legend.percentageLabel || 'percentage'}:${percent}%, ${ctrl.panel.legend.totalPercentageLabel || '总占比'}:${totalpercent})`;\r\n          } else {\r\n            body += \" (\" + totalpercent + \")\";\r\n          }\r\n        }\r\n      } else {\r\n        body += \" (\" + percent + \"%)\";\r\n      }\r\n\r\n      body += '</div>';\r\n      body += \"</div></div>\";\r\n\r\n      $tooltip.html(body).place_tt(pos.pageX + 20, pos.pageY);\r\n    });\r\n  }\r\n\r\n  function render(incrementRenderCounter) {\r\n    if (!ctrl.data) { return; }\r\n\r\n    data = ctrl.data;\r\n    panel = ctrl.panel;\r\n\r\n    if (setElementHeight()) {\r\n      addPieChart();\r\n    }\r\n    if (incrementRenderCounter) {\r\n      ctrl.renderingCompleted();\r\n    }\r\n  }\r\n}\r\n\r\n"]}